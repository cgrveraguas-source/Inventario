<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA DE GESTI√ìN DE INVENTARIO TECNOL√ìGICO - DIRECCI√ìN DE TECNOLOG√çA PROVINCIAL DE Veraguas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 100vw;
            margin: 0 auto;
            padding: 10px;
            background: white;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 15px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .search-container {
            flex: 1;
            min-width: 250px;
            display: flex;
            align-items: center;
        }

        .search-input {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #2a5298;
            border-radius: 25px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: #1e3c72;
            box-shadow: 0 0 10px rgba(42, 82, 152, 0.3);
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            white-space: nowrap;
            transition: all 0.3s ease;
            position: relative;
        }

        .btn:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2a5298;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        .btn-primary {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(42, 82, 152, 0.4);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #2a5298;
            border: 2px solid #2a5298;
        }

        .btn-secondary:hover {
            background: #2a5298;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-loans {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-loans:hover {
            background: linear-gradient(135deg, #218838 0%, #1ea080 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-phone {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
        }

        .btn-phone:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(23, 162, 184, 0.4);
        }

        /* Barra de filtros en una sola l√≠nea */
        .filter-container {
            display: flex;
            gap: 30px;
            align-items: center;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-group label {
            font-weight: 600;
            color: #2c5aa0;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-group select {
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            min-width: 200px;
            background: white;
            transition: all 0.3s ease;
        }

        .filter-group select:focus {
            outline: none;
            border-color: #2c5aa0;
            box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
        }

        .filter-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 12px;
            color: #666;
            margin-left: auto;
        }

        .filter-badge {
            background: #2a5298;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        /* Tarjetas de estad√≠sticas mejoradas con m√°s vida */
        .stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            flex: 1;
            min-width: 140px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 15px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            cursor: pointer;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
        }

        .stat-card:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(42, 82, 152, 0.2);
            border-color: #2a5298;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2a5298;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        /* Tarjetas de tipo de equipo */
        .equipment-types {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .type-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 120px;
            position: relative;
            overflow: hidden;
        }

        .type-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .type-card:hover::before,
        .type-card.active::before {
            transform: scaleX(1);
        }

        .type-card:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.2);
            border-color: #28a745;
        }

        .type-card.active {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-color: #28a745;
            color: #155724;
        }

        .type-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
            display: block;
        }

        .type-name {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-count {
            font-size: 0.7rem;
            color: #666;
            margin-top: 2px;
        }

        /* Tarjetas de conteo por tipo en b√∫squedas */
        .search-type-stats {
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            justify-content: center; /* CENTRAR LAS TARJETAS */
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            border-radius: 10px;
            border: 2px solid #2196f3;
        }

        .search-type-stats.show {
            display: flex;
        }

        .search-type-card {
            background: white;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 8px 12px;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 2px 5px rgba(33, 150, 243, 0.2);
        }

        .search-type-card .count {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2196f3;
        }

        .search-type-card .label {
            font-size: 0.7rem;
            color: #666;
            text-transform: uppercase;
        }

        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-height: calc(100vh - 500px);
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        th {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 8px 4px;
            text-align: left;
            font-weight: 600;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
        }

        th:hover {
            background: linear-gradient(135deg, #3a66b8 0%, #2e4ca2 100%);
        }

        td {
            padding: 6px 4px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: top;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .prestado-row {
            background-color: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        .prestado-row:hover {
            background-color: #ffeaa7 !important;
        }

        .estado-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .estado-disponible {
            background-color: #d4edda;
            color: #155724;
        }

        .estado-prestado {
            background-color: #fff3cd;
            color: #856404;
        }

        .actions {
            display: flex;
            gap: 3px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 2px;
            color: #2a5298;
            transition: color 0.2s ease;
            position: relative;
        }

        .btn-icon:hover {
            color: #1e3c72;
        }

        .btn-icon:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #2a5298;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
        }

        /* Paginaci√≥n */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 15px;
        }

        .pagination-info {
            font-size: 14px;
            color: #666;
            font-weight: 600;
        }

        .pagination-buttons {
            display: flex;
            gap: 10px;
        }

        .pagination-btn {
            padding: 8px 15px;
            border: 2px solid #2a5298;
            background: white;
            color: #2a5298;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #2a5298;
            color: white;
            transform: translateY(-2px);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .last-updated {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #2a5298;
            border-radius: 15px;
            font-size: 12px;
            color: #2a5298;
            font-weight: bold;
            text-transform: uppercase;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 20px;
            border-radius: 15px;
            width: 98%;
            max-width: 1000px;
            max-height: 90vh;
            overflow: visible;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2a5298;
        }

        .modal-title {
            color: #2a5298;
            font-size: 1.2rem;
            font-weight: bold;
            text-transform: uppercase;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #2a5298;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2a5298;
            text-transform: uppercase;
            font-size: 12px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 8px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus {
            border-color: #2a5298;
            outline: none;
            box-shadow: 0 0 5px rgba(42, 82, 152, 0.3);
        }

        .form-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .hidden {
            display: none !important;
        }

        .success-message, .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            animation: slideIn 0.3s ease;
        }

        .success-message {
            background: #28a745;
        }

        .error-message {
            background: #dc3545;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Estilos para pr√©stamos */
        .loans-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .loan-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .loan-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 10px 0;
        }

        .loan-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .loan-active {
            background-color: #fff3cd;
            color: #856404;
        }

        .loan-returned {
            background-color: #d4edda;
            color: #155724;
        }

        /* Estilos responsivos */
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-container {
                margin-bottom: 10px;
            }

            .filter-container {
                flex-direction: column;
                gap: 15px;
            }

            .form-container {
                grid-template-columns: 1fr;
            }

            .loan-form {
                grid-template-columns: 1fr;
            }

            .stats {
                flex-direction: column;
            }

            .equipment-types {
                justify-content: flex-start;
            }

            table {
                font-size: 10px;
            }

            th, td {
                padding: 4px 2px;
            }
        }

        /* Estilos para campos con opci√≥n "Otro" */
        .custom-input {
            margin-top: 5px;
            display: none;
        }

        .custom-input.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Sistema de Gesti√≥n de Inventario Tecnol√≥gico</h1>
            <p>Direcci√≥n de Tecnolog√≠a Provincial de Veraguas</p>
        </div>

        <div class="controls">
            <div class="search-container">
                <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar por cualquier campo..." onkeyup="searchTable()">
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="openAddModal()" data-tooltip="Agregar nuevo equipo">‚ûï Agregar</button>
                <button class="btn btn-secondary" onclick="openReportModal()" data-tooltip="Generar reportes">üìä Reportes</button>
                <button class="btn btn-loans" onclick="openLoansModal()" data-tooltip="Gestionar pr√©stamos">üîÑ Pr√©stamos</button>
                <button class="btn btn-phone" onclick="openPhoneGuideModal()" data-tooltip="Gu√≠a telef√≥nica por departamento">üìû Gu√≠a Telef√≥nica</button>
                <button class="btn btn-secondary" onclick="exportToCSV()" data-tooltip="Exportar datos">üì§ Exportar</button>
                <button class="btn btn-secondary" onclick="importFromCSV()" data-tooltip="Importar datos">üì• Importar</button>
                <button class="btn btn-secondary" onclick="backupData()" data-tooltip="Respaldar datos">üíæ Respaldo</button>
                <button class="btn btn-secondary" onclick="restoreData()" data-tooltip="Restaurar datos">üìÇ Restaurar</button>
                <button class="btn btn-secondary" onclick="clearFilters()" data-tooltip="Limpiar filtros activos">üîÑ Limpiar Filtro</button>
                <button class="btn btn-danger" onclick="clearFilters()" data-tooltip="Limpiar filtros activos">üóëÔ∏è Limpiar Todo</button>
            </div>
        </div>

        <!-- Barra de filtros en una sola l√≠nea -->
        <div class="filter-container">
            <div class="filter-group">
                <label for="departmentFilter">Departamento:</label>
                <select id="departmentFilter" onchange="applyFilters()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="typeFilter">Tipo:</label>
                <select id="typeFilter" onchange="applyFilters()">
                    <option value="">Todos</option>
                </select>
            </div>
            <div class="filter-status">
                <span>Filtros activos:</span>
                <span id="activeFilters" class="filter-badge">0</span>
            </div>
        </div>

        <!-- Estad√≠sticas mejoradas - ELIMINADAS DEPARTAMENTOS Y TIPOS -->
        <div class="stats">
            <div class="stat-card" onclick="filterByStatus('all')">
                <div class="stat-number" id="totalEquipment">0</div>
                <div class="stat-label">Total Equipos</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('DISPONIBLE')">
                <div class="stat-number" id="availableEquipment">0</div>
                <div class="stat-label">Disponibles</div>
            </div>
            <div class="stat-card" onclick="filterByStatus('PRESTADO')">
                <div class="stat-number" id="loanedEquipment">0</div>
                <div class="stat-label">Prestados</div>
            </div>
        </div>

        <!-- Tarjetas de conteo por tipo en b√∫squedas -->
        <div class="search-type-stats" id="searchTypeStats">
            <!-- Se llenar√°n din√°micamente cuando hay b√∫squeda activa -->
        </div>

        <!-- Tarjetas de tipos de equipo -->
        <div class="equipment-types" id="equipmentTypes">
            <!-- Se llenar√°n din√°micamente -->
        </div>

        <div class="table-container">
            <table id="inventoryTable">
                <thead>
                    <tr>
                        <th onclick="sortTable(0)">UBICACI√ìN</th>
                        <th onclick="sortTable(1)">DEPARTAMENTO</th>
                        <th onclick="sortTable(2)">USUARIO</th>
                        <th onclick="sortTable(3)">USUARIO RED</th>
                        <th onclick="sortTable(4)">TELE-IP</th>
                        <th onclick="sortTable(5)">NOMBRE EQUIPO</th>
                        <th onclick="sortTable(6)">PLACA</th>
                        <th onclick="sortTable(7)">TIPO</th>
                        <th onclick="sortTable(8)">FABRICANTE</th>
                        <th onclick="sortTable(9)">MODELO</th>
                        <th onclick="sortTable(10)">SERIE</th>
                        <th onclick="sortTable(11)">OS</th>
                        <th onclick="sortTable(12)">IP</th>
                        <th onclick="sortTable(13)">RAM</th>
                        <th onclick="sortTable(14)">DISCO</th>
                        <th onclick="sortTable(15)">ESTADO</th>
                        <th>ACCIONES</th>
                    </tr>
                </thead>
                <tbody id="inventoryTableBody">
                    <!-- Los datos se cargar√°n aqu√≠ din√°micamente -->
                </tbody>
            </table>
        </div>

        <!-- Paginaci√≥n -->
        <div class="pagination-container">
            <div class="pagination-info">
                Mostrando <span id="currentRange">0-0</span> de <span id="totalItems">0</span> registros
            </div>
            <div class="pagination-buttons">
                <button class="pagination-btn" onclick="changePage(-1)" id="prevBtn">‚¨ÖÔ∏è Anterior</button>
                <button class="pagination-btn" onclick="changePage(1)" id="nextBtn">Siguiente ‚û°Ô∏è</button>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">
            √öltima actualizaci√≥n: Nunca
        </div>
    </div>

    <!-- Modal para agregar/editar equipo -->
    <div id="equipmentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Agregar Nuevo Equipo</h2>
                <span class="close" onclick="closeModal('equipmentModal')">&times;</span>
            </div>
            <form id="equipmentForm">
                <div class="form-container">
                    <div class="form-group">
                        <label class="form-label" for="ubicacion">Ubicaci√≥n:</label>
                        <input type="text" id="ubicacion" class="form-input" value="CHIRIQUI" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="departamento">Departamento:</label>
                        <select id="departamento" class="form-select" required onchange="handleOtroOption('departamento')">
                            <option value="">Seleccionar departamento</option>
                        </select>
                        <input type="text" id="departamento_custom" class="form-input custom-input" placeholder="Especificar departamento">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="usuario">Usuario:</label>
                        <input type="text" id="usuario" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="usuarioRed">Usuario Red:</label>
                        <input type="text" id="usuarioRed" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="teleIp">Tele-IP:</label>
                        <input type="text" id="teleIp" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="nombreEquipo">Nombre Equipo:</label>
                        <input type="text" id="nombreEquipo" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="placa">Placa:</label>
                        <input type="text" id="placa" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="tipo">Tipo:</label>
                        <select id="tipo" class="form-select" required onchange="handleOtroOption('tipo')">
                            <option value="">Seleccionar tipo</option>
                        </select>
                        <input type="text" id="tipo_custom" class="form-input custom-input" placeholder="Especificar tipo">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="fabricante">Fabricante:</label>
                        <select id="fabricante" class="form-select" onchange="handleOtroOption('fabricante')">
                            <option value="">Seleccionar fabricante</option>
                        </select>
                        <input type="text" id="fabricante_custom" class="form-input custom-input" placeholder="Especificar fabricante">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="modelo">Modelo:</label>
                        <select id="modelo" class="form-select" onchange="handleOtroOption('modelo')">
                            <option value="">Seleccionar modelo</option>
                        </select>
                        <input type="text" id="modelo_custom" class="form-input custom-input" placeholder="Especificar modelo">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="serie">Serie:</label>
                        <input type="text" id="serie" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="os">Sistema Operativo:</label>
                        <select id="os" class="form-select" onchange="handleOtroOption('os')">
                            <option value="">Seleccionar sistema operativo</option>
                        </select>
                        <input type="text" id="os_custom" class="form-input custom-input" placeholder="Especificar sistema operativo">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="ip">Direcci√≥n IP:</label>
                        <input type="text" id="ip" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="ram">Memoria RAM:</label>
                        <select id="ram" class="form-select" onchange="handleOtroOption('ram')">
                            <option value="">Seleccionar memoria RAM</option>
                        </select>
                        <input type="text" id="ram_custom" class="form-input custom-input" placeholder="Especificar memoria RAM">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="disco">Disco Duro:</label>
                        <select id="disco" class="form-select" onchange="handleOtroOption('disco')">
                            <option value="">Seleccionar disco duro</option>
                        </select>
                        <input type="text" id="disco_custom" class="form-input custom-input" placeholder="Especificar disco duro">
                    </div>
                </div>
                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('equipmentModal')">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal para reportes -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Generar Reporte</h2>
                <span class="close" onclick="closeModal('reportModal')">&times;</span>
            </div>
            <div class="form-container">
                <div class="form-group">
                    <label class="form-label" for="reportDepartamento">Departamento:</label>
                    <select id="reportDepartamento" class="form-input" onchange="updateUsuarioSelect()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="reportTipo">Tipo de Equipo:</label>
                    <select id="reportTipo" class="form-input">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="reportUsuario">Usuario:</label>
                    <select id="reportUsuario" class="form-input">
                        <option value="">Todos</option>
                    </select>
                </div>
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="showReportPreview()">Vista Previa</button>
                <button class="btn btn-primary" onclick="generatePrintableReport()">Imprimir Directamente</button>
            </div>
        </div>
    </div>

    <!-- Modal para vista previa del reporte -->
    <div id="previewModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 95%;">
            <div class="modal-header">
                <h2 class="modal-title">Vista Previa del Reporte</h2>
                <span class="close" onclick="closeModal('previewModal')">&times;</span>
            </div>
            <div id="previewContainer" style="max-height: 70vh; overflow-y: auto; border: 1px solid #ddd; padding: 20px;">
                <!-- El contenido del reporte se mostrar√° aqu√≠ -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-secondary" onclick="closeModal('previewModal')">Cerrar</button>
                <button class="btn btn-primary" onclick="printFromPreview()">Imprimir</button>
            </div>
        </div>
    </div>

    <!-- Modal para pr√©stamos -->
    <div id="loansModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Gesti√≥n de Pr√©stamos</h2>
                <span class="close" onclick="closeModal('loansModal')">&times;</span>
            </div>
            
            <div class="loans-tabs">
                <button class="tab-button active" onclick="switchTab('newLoan')">Nuevo Pr√©stamo</button>
                <button class="tab-button" onclick="switchTab('activeLoan')">Pr√©stamos Activos</button>
                <button class="tab-button" onclick="switchTab('loanHistory')">Historial</button>
            </div>

            <!-- Pesta√±a de nuevo pr√©stamo -->
            <div id="newLoan" class="tab-content active">
                <div class="form-group">
                    <label class="form-label" for="searchEquipmentLoan">BUSCAR EQUIPO (PLACA, SERIE O NOMBRE):</label>
                    <input type="text" id="searchEquipmentLoan" class="form-input" placeholder="Escriba para buscar equipos disponibles..." onkeyup="searchEquipmentForLoan()">
                    <div id="equipmentSearchResults" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; margin-top: 5px; display: none;">
                        <!-- Resultados de b√∫squeda aparecer√°n aqu√≠ -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="selectedEquipmentDisplay">EQUIPO SELECCIONADO:</label>
                    <input type="text" id="selectedEquipmentDisplay" class="form-input" readonly placeholder="Ning√∫n equipo seleccionado">
                    <input type="hidden" id="selectedEquipmentId">
                </div>

                <div class="form-group">
                    <label class="form-label" for="loanBorrowerName">PRESTATARIO (NOMBRE O DEPARTAMENTO):</label>
                    <input type="text" id="loanBorrowerName" class="form-input" required placeholder="Nombre del prestatario o departamento">
                </div>

                <div class="form-group">
                    <label class="form-label" for="loanStartDate">FECHA DE PR√âSTAMO:</label>
                    <input type="date" id="loanStartDate" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="loanExpectedReturn">FECHA DE DEVOLUCI√ìN ESPERADA:</label>
                    <input type="date" id="loanExpectedReturn" class="form-input" required>
                </div>

                <div class="form-group">
                    <label class="form-label" for="loanObservations">OBSERVACIONES (OPCIONAL):</label>
                    <textarea id="loanObservations" class="form-input" rows="3" placeholder="Cualquier nota relevante sobre el pr√©stamo..."></textarea>
                </div>

                <div class="form-buttons">
                    <button type="button" class="btn btn-secondary" onclick="clearLoanForm()">LIMPIAR</button>
                    <button type="button" class="btn btn-primary" onclick="createNewLoan()">PRESTAR EQUIPO</button>
                </div>
            </div>

            <!-- Pesta√±a de pr√©stamos activos -->
            <div id="activeLoan" class="tab-content">
                <div id="activeLoansContainer">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </div>

            <!-- Pesta√±a de historial -->
            <div id="loanHistory" class="tab-content">
                <div id="loanHistoryContainer">
                    <!-- Se llenar√°n din√°micamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Input oculto para importar CSV -->
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">
    
    <!-- Input oculto para restaurar JSON -->
    <input type="file" id="jsonFileInput" accept=".json" style="display: none;" onchange="handleJSONRestore(event)">

    <!-- Modal para gu√≠a telef√≥nica -->
    <div id="phoneGuideModal" class="modal">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header">
                <h2 class="modal-title">üìû Gu√≠a Telef√≥nica por Departamento</h2>
                <span class="close" onclick="closeModal('phoneGuideModal')">&times;</span>
            </div>
            
            <!-- Filtros de la gu√≠a telef√≥nica -->
            <div class="filter-container" style="margin-bottom: 20px;">
                <div class="filter-group">
                    <label for="phoneGuideDepartmentFilter">Departamento:</label>
                    <select id="phoneGuideDepartmentFilter" onchange="applyPhoneGuideFilters()">
                        <option value="">Todos los departamentos</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="phoneGuideSearchInput">Buscar:</label>
                    <input type="text" id="phoneGuideSearchInput" class="form-input" placeholder="Buscar por usuario, tel√©fono..." onkeyup="applyPhoneGuideFilters()" style="min-width: 250px;">
                </div>
                <div class="filter-group">
                    <button class="btn btn-secondary" onclick="clearPhoneGuideFilters()">üîÑ Limpiar Filtros</button>
                    <button class="btn btn-primary" onclick="exportPhoneGuide()">üì§ Exportar Contactos</button>
                </div>
            </div>

            <!-- Tabla de contactos -->
            <div style="max-height: 60vh; overflow-y: auto; border: 1px solid #ddd;">
                <table id="phoneGuideTable" style="width: 100%; border-collapse: collapse;">
                    <thead style="position: sticky; top: 0; background: #2a5298; color: white;">
                        <tr>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">DEPARTAMENTO</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">USUARIO</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">TEL√âFONO/IP</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">USUARIO RED</th>
                            <th style="padding: 10px; text-align: left; border: 1px solid #ddd;">UBICACI√ìN</th>
                        </tr>
                    </thead>
                    <tbody id="phoneGuideTableBody">
                        <!-- Los contactos se cargar√°n aqu√≠ din√°micamente -->
                    </tbody>
                </table>
            </div>

            <!-- Estad√≠sticas de contactos -->
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                <span id="phoneGuideStats">Mostrando 0 contactos</span>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
		const API_URL = 'https://script.google.com/macros/s/AKfycby1Hdv1nXKEBVeSGjW931GMH6sJrpTeg8Qw7sz1i9nt_4_4yGQlQkwsxWvIwd8uygk9/exec';
        let inventory = [];
        let loans = [];
        let filteredData = [];
        let currentPage = 1;
        const itemsPerPage = 50;
        let sortColumn = -1;
        let sortDirection = 'asc';
        let editingId = null;

        // Datos de ejemplo del inventario
        const sampleData = [
            {
                        "id": "item_1",
                        "ubicacion": "CHIRIQUI",
                        "departamento": "DFG - HOSPITAL DIONISIO ARROCHA",
                        "usuario": "IVAN GONZALEZ",
                        "usuarioRed": "IVGONZALEZ",
                        "teleIp": "728-1153",
                        "nombreEquipo": "N/A",
                        "placa": "S-29850",
                        "tipo": "TECLADO",
                        "fabricante": "LENOVO",
                        "modelo": "KU-1601",
                        "serie": "8SSD51B37289AVL34R0237",
                        "os": "N/A",
                        "ip": "N/A",
                        "ram": "N/A",
                        "disco": "N/A",
                        "estado": "DISPONIBLE"
            },
            {
                        "id": "item_2",
                        "ubicacion": "CHIRIQUI",
                        "departamento": "DFG - HOSPITAL DIONISIO ARROCHA",
                        "usuario": "IVAN GONZALEZ",
                        "usuarioRed": "IVGONZALEZ",
                        "teleIp": "728-1153",
                        "nombreEquipo": "N/A",
                        "placa": "N/A",
                        "tipo": "MONITOR",
                        "fabricante": "N/A",
                        "modelo": "N/A",
                        "serie": "N/A",
                        "os": "N/A",
                        "ip": "N/A",
                        "ram": "N/A",
                        "disco": "N/A",
                        "estado": "DISPONIBLE"
            }
        ];

        // Funci√≥n para manejar la opci√≥n "Otro"
        function handleOtroOption(fieldName) {
            const select = document.getElementById(fieldName);
            const customInput = document.getElementById(fieldName + '_custom');
            
            if (select.value === 'OTRO') {
                customInput.classList.add('show');
                customInput.required = true;
            } else {
                customInput.classList.remove('show');
                customInput.required = false;
                customInput.value = '';
            }
        }

        // Funci√≥n para obtener el valor final del campo (select o custom)
        function getFieldValue(fieldName) {
            const select = document.getElementById(fieldName);
            const customInput = document.getElementById(fieldName + '_custom');
            
            if (select.value === 'OTRO' && customInput.value.trim() !== '') {
                return customInput.value.trim();
            }
            return select.value;
        }

        // Funci√≥n para establecer el valor del campo (para edici√≥n)
        function setFieldValue(fieldName, value) {
            const select = document.getElementById(fieldName);
            const customInput = document.getElementById(fieldName + '_custom');
            
            // Buscar si el valor existe en las opciones del select
            let optionExists = false;
            for (let option of select.options) {
                if (option.value === value) {
                    optionExists = true;
                    break;
                }
            }
            
            if (optionExists) {
                select.value = value;
                customInput.classList.remove('show');
                customInput.required = false;
                customInput.value = '';
            } else {
                select.value = 'OTRO';
                customInput.classList.add('show');
                customInput.required = true;
                customInput.value = value;
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            updateFilters();
            updateStats();
            renderTable();
            updateLastUpdated();
            populateReportFilters();
            updateLoanEquipmentSelect();
        });

        // ===== FUNCIONES DE DATOS =====
        async function loadData() {
  try {
    const res = await fetch(`${'https://script.google.com/macros/s/AKfycby1Hdv1nXKEBVeSGjW931GMH6sJrpTeg8Qw7sz1i9nt_4_4yGQlQkwsxWvIwd8uygk9/exec'}?t=${Date.now()}`);
    const j = await res.json();
    inventory = Array.isArray(j?.data?.inventory) ? j.data.inventory : [];
    loans     = Array.isArray(j?.data?.loans)     ? j.data.loans     : [];
    // Mantengo tu cache local para que TODO siga funcionando offline
    localStorage.setItem('inventory', JSON.stringify(inventory));
    localStorage.setItem('loans', JSON.stringify(loans));
  } catch (e) {
    console.warn('Fallo API, uso cache local', e);
    const savedInventory = localStorage.getItem('inventory');
    const savedLoans     = localStorage.getItem('loans');
    inventory = savedInventory ? JSON.parse(savedInventory) : [];
    loans     = savedLoans     ? JSON.parse(savedLoans)     : [];
  }
  filteredData = [...inventory];
}


        async function saveData() {
  // seguimos actualizando la marca de tiempo en la UI
  updateLastUpdated();
  // guardo tambi√©n en cache local (por continuidad con tu c√≥digo actual)
  localStorage.setItem('inventory', JSON.stringify(inventory));
  localStorage.setItem('loans', JSON.stringify(loans));
  // Env√≠o a Sheets (bulk, simple y robusto)
  try {
    await fetch('https://script.google.com/macros/s/AKfycby1Hdv1nXKEBVeSGjW931GMH6sJrpTeg8Qw7sz1i9nt_4_4yGQlQkwsxWvIwd8uygk9/exec, {
      method: 'POST',
      // Sugerido para evitar preflight en algunos navegadores m√≥viles
      // (tambi√©n sirve application/json si prefieres)
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ action: 'bulkSave', inventory, loans })
    });
  } catch (e) {
    console.error('No se pudo guardar en Sheets (queda en cache):', e);
  }
}


        function updateLastUpdated() {
            const now = new Date();
            const formatted = now.toLocaleString('es-ES');
            document.getElementById('lastUpdated').textContent = `√öltima actualizaci√≥n: ${formatted}`;
        }

        // ===== FUNCIONES DE FILTROS =====
        function updateFilters() {
            const departments = [...new Set(inventory.map(item => item.departamento))].sort();
            const types = [...new Set(inventory.map(item => item.tipo))].sort();
            const users = [...new Set(inventory.map(item => item.usuario))].sort();

            populateSelect('departmentFilter', departments);
            populateSelect('typeFilter', types);
            populateSelect('reportDepartamento', departments);
            populateSelect('reportTipo', types);
            populateSelect('reportUsuario', users);
            
            // Poblar selects del formulario con datos existentes
            populateFormSelects();
        }

        // Funci√≥n para poblar los selects del formulario con datos existentes
        function populateFormSelects() {
            const departments = [...new Set(inventory.map(item => item.departamento).filter(item => item && item.trim() !== ''))].sort();
            const types = [...new Set(inventory.map(item => item.tipo).filter(item => item && item.trim() !== ''))].sort();
            const manufacturers = [...new Set(inventory.map(item => item.fabricante).filter(item => item && item.trim() !== '' && item !== 'N/A'))].sort();
            const models = [...new Set(inventory.map(item => item.modelo).filter(item => item && item.trim() !== '' && item !== 'N/A'))].sort();
            const operatingSystems = [...new Set(inventory.map(item => item.os).filter(item => item && item.trim() !== '' && item !== 'N/A'))].sort();
            const ramOptions = [...new Set(inventory.map(item => item.ram).filter(item => item && item.trim() !== '' && item !== 'N/A'))].sort();
            const diskOptions = [...new Set(inventory.map(item => item.disco).filter(item => item && item.trim() !== '' && item !== 'N/A'))].sort();

            populateFormSelect('departamento', departments);
            populateFormSelect('tipo', types);
            populateFormSelect('fabricante', manufacturers);
            populateFormSelect('modelo', models);
            populateFormSelect('os', operatingSystems);
            populateFormSelect('ram', ramOptions);
            populateFormSelect('disco', diskOptions);
        }

        // Funci√≥n espec√≠fica para poblar selects del formulario
        function populateFormSelect(selectId, options) {
            const select = document.getElementById(selectId);
            if (!select) return;
            
            const currentValue = select.value;
            
            // Limpiar opciones existentes excepto la primera y "OTRO"
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Agregar opciones existentes en el inventario
            options.forEach(option => {
                if (option && option.trim() !== '') {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                }
            });
            
            // Agregar opci√≥n "OTRO" al final
            const otroOption = document.createElement('option');
            otroOption.value = 'OTRO';
            otroOption.textContent = 'OTRO';
            select.appendChild(otroOption);
            
            // Restaurar valor seleccionado si existe
            if (currentValue && (options.includes(currentValue) || currentValue === 'OTRO')) {
                select.value = currentValue;
            }
        }

        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Limpiar opciones existentes excepto la primera
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Agregar nuevas opciones
            options.forEach(option => {
                if (option && option.trim() !== '') {
                    const optionElement = document.createElement('option');
                    optionElement.value = option;
                    optionElement.textContent = option;
                    select.appendChild(optionElement);
                }
            });
            
            // Restaurar valor seleccionado si existe
            if (currentValue && options.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function applyFilters() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredData = inventory.filter(item => {
                const matchesFilters = (!departmentFilter || item.departamento === departmentFilter) &&
                                     (!typeFilter || item.tipo === typeFilter);
                
                // Si hay b√∫squeda activa, aplicar tambi√©n el filtro de b√∫squeda
                if (searchTerm.trim() !== '') {
                    const matchesSearch = Object.values(item).some(value => 
                        value && value.toString().toLowerCase().includes(searchTerm)
                    );
                    return matchesFilters && matchesSearch;
                }
                
                return matchesFilters;
            });
            
            // Si hay b√∫squeda activa, mostrar estad√≠sticas por tipo
            if (searchTerm.trim() !== '') {
                updateSearchTypeStats();
            } else {
                document.getElementById('searchTypeStats').classList.remove('show');
            }
            
            updateActiveFiltersCount();
            currentPage = 1;
            renderTable();
            updateStats();
        }

        // NUEVA FUNCI√ìN: Aplicar filtros manteniendo el ordenamiento actual
        function applyFiltersWithSort() {
            applyFilters();
            
            // Si hay un ordenamiento activo, reaplicarlo
            if (sortColumn !== -1) {
                const columns = ['ubicacion', 'departamento', 'usuario', 'usuarioRed', 'teleIp', 'nombreEquipo', 'placa', 'tipo', 'fabricante', 'modelo', 'serie', 'os', 'ip', 'ram', 'disco', 'estado'];
                const column = columns[sortColumn];
                
                filteredData.sort((a, b) => {
                    let aVal = a[column] || '';
                    let bVal = b[column] || '';
                    
                    if (sortDirection === 'asc') {
                        return aVal.localeCompare(bVal);
                    } else {
                        return bVal.localeCompare(aVal);
                    }
                });
                
                renderTable();
            }
        }

        // NUEVA FUNCI√ìN: Limpiar filtros
        function clearFilters() {
            document.getElementById('departmentFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('searchInput').value = '';
            
            // Ocultar estad√≠sticas de b√∫squeda
            document.getElementById('searchTypeStats').classList.remove('show');
            
            // Limpiar tarjetas activas
            document.querySelectorAll('.type-card').forEach(card => {
                card.classList.remove('active');
            });
            
            // Aplicar filtros vac√≠os (mostrar todo)
            filteredData = [...inventory];
            updateActiveFiltersCount();
            currentPage = 1;
            renderTable();
            updateStats();
            
            showSuccess('Filtros limpiados exitosamente');
        }

        function updateActiveFiltersCount() {
            const departmentFilter = document.getElementById('departmentFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            let activeCount = 0;
            if (departmentFilter) activeCount++;
            if (typeFilter) activeCount++;
            
            document.getElementById('activeFilters').textContent = activeCount;
        }

        function filterByStatus(status) {
            if (status === 'all') {
                filteredData = [...inventory];
            } else {
                filteredData = inventory.filter(item => item.estado === status);
            }
            
            // Limpiar filtros de selects
            document.getElementById('departmentFilter').value = '';
            document.getElementById('typeFilter').value = '';
            updateActiveFiltersCount();
            
            currentPage = 1;
            renderTable();
        }

        function searchTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm.trim() === '') {
                // Si no hay b√∫squeda, ocultar estad√≠sticas de b√∫squeda y aplicar filtros normales
                document.getElementById('searchTypeStats').classList.remove('show');
                applyFilters();
                return;
            }
            
            // Aplicar b√∫squeda
            const departmentFilter = document.getElementById('departmentFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            filteredData = inventory.filter(item => {
                const matchesSearch = Object.values(item).some(value => 
                    value && value.toString().toLowerCase().includes(searchTerm)
                );
                const matchesFilters = (!departmentFilter || item.departamento === departmentFilter) &&
                                     (!typeFilter || item.tipo === typeFilter);
                return matchesSearch && matchesFilters;
            });
            
            // Mostrar estad√≠sticas por tipo para la b√∫squeda
            updateSearchTypeStats();
            
            currentPage = 1;
            renderTable();
        }

        // Nueva funci√≥n para mostrar estad√≠sticas por tipo en b√∫squedas
        function updateSearchTypeStats() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (searchTerm.trim() === '' || filteredData.length === 0) {
                document.getElementById('searchTypeStats').classList.remove('show');
                return;
            }
            
            // Contar por tipo en los resultados filtrados
            const typeCounts = {};
            filteredData.forEach(item => {
                typeCounts[item.tipo] = (typeCounts[item.tipo] || 0) + 1;
            });
            
            const container = document.getElementById('searchTypeStats');
            container.innerHTML = '';
            
            // Crear tarjetas para cada tipo encontrado
            Object.entries(typeCounts).forEach(([type, count]) => {
                const card = document.createElement('div');
                card.className = 'search-type-card';
                card.innerHTML = `
                    <div class="count">${count}</div>
                    <div class="label">${type}</div>
                `;
                container.appendChild(card);
            });
            
            container.classList.add('show');
        }

        // ===== FUNCIONES DE ESTAD√çSTICAS =====
        function updateStats() {
            const total = inventory.length;
            const available = inventory.filter(item => item.estado === 'DISPONIBLE').length;
            const loaned = inventory.filter(item => item.estado === 'PRESTADO').length;
            
            document.getElementById('totalEquipment').textContent = total;
            document.getElementById('availableEquipment').textContent = available;
            document.getElementById('loanedEquipment').textContent = loaned;
            
            updateEquipmentTypes();
        }

        // FUNCI√ìN REPARADA: Mapeo correcto de iconos por tipo de equipo
        function updateEquipmentTypes() {
            const typeCounts = {};
            inventory.forEach(item => {
                // Verificar que item.tipo existe y no es null/undefined
                const tipo = item.tipo || 'OTRO';
                typeCounts[tipo] = (typeCounts[tipo] || 0) + 1;
            });
            
            const container = document.getElementById('equipmentTypes');
            container.innerHTML = '';
            
            // MAPEO CORREGIDO: Iconos por tipo, no por fabricante
            const typeIcons = {
                'COMPUTADORA DESKTOP': 'üñ•Ô∏è',
                'COMPUTADORA PORTATIL': 'üíª',
                'LAPTOP': 'üíª',
                'IMPRESORA': 'üñ®Ô∏è',
                'MONITOR': 'üì∫',
                'TECLADO': '‚å®Ô∏è',
                'MOUSE': 'üñ±Ô∏è',
                'SCANNER': 'üì†',
                'PROYECTOR': 'üìΩÔ∏è',
                'SWITCH': 'üîÄ',
                'ROUTER': 'üì°',
                'UPS': 'üîã',
                'SERVIDOR': 'üñ•Ô∏è',
                'TABLET': 'üì±',
                'TELEFONO': 'üìû',
                'OTRO': 'üì¶'
            };
            
            Object.entries(typeCounts).forEach(([type, count]) => {
                const card = document.createElement('div');
                card.className = 'type-card';
                card.onclick = () => filterByType(type);
                card.innerHTML = `
                    <span class="type-icon">${typeIcons[type] || 'üì¶'}</span>
                    <div class="type-name">${type}</div>
                    <div class="type-count">${count} equipos</div>
                `;
                container.appendChild(card);
            });
        }

        function filterByType(type) {
            document.getElementById('typeFilter').value = type;
            applyFilters();
            
            // Actualizar tarjetas activas
            document.querySelectorAll('.type-card').forEach(card => {
                card.classList.remove('active');
            });
            event.target.closest('.type-card').classList.add('active');
        }

        // ===== FUNCIONES DE TABLA =====
        function renderTable() {
            const tbody = document.getElementById('inventoryTableBody');
            tbody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);
            
            pageData.forEach(item => {
                const row = document.createElement('tr');
                if (item.estado === 'PRESTADO') {
                    row.classList.add('prestado-row');
                }
                
                row.innerHTML = `
                    <td>${item.ubicacion || 'N/A'}</td>
                    <td>${item.departamento || 'N/A'}</td>
                    <td>${item.usuario || 'N/A'}</td>
                    <td>${item.usuarioRed || 'N/A'}</td>
                    <td>${item.teleIp || 'N/A'}</td>
                    <td>${item.nombreEquipo || 'N/A'}</td>
                    <td>${item.placa || 'N/A'}</td>
                    <td>${item.tipo || 'N/A'}</td>
                    <td>${item.fabricante || 'N/A'}</td>
                    <td>${item.modelo || 'N/A'}</td>
                    <td>${item.serie || 'N/A'}</td>
                    <td>${item.os || 'N/A'}</td>
                    <td>${item.ip || 'N/A'}</td>
                    <td>${item.ram || 'N/A'}</td>
                    <td>${item.disco || 'N/A'}</td>
                    <td><span class="estado-badge estado-${item.estado.toLowerCase()}">${item.estado}</span></td>
                    <td class="actions">
                        <button class="btn-icon" onclick="copyItem('${item.id}')" data-tooltip="Copiar">üìã</button>
                        <button class="btn-icon" onclick="editItem('${item.id}')" data-tooltip="Editar">‚úèÔ∏è</button>
                        <button class="btn-icon" onclick="deleteItem('${item.id}')" data-tooltip="Eliminar">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updatePagination();
        }

        function updatePagination() {
            const totalItems = filteredData.length;
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, totalItems);
            
            document.getElementById('currentRange').textContent = `${startIndex}-${endIndex}`;
            document.getElementById('totalItems').textContent = totalItems;
            
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages || totalPages === 0;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderTable();
            }
        }

        function sortTable(columnIndex) {
            if (sortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = columnIndex;
                sortDirection = 'asc';
            }
            
            const columns = ['ubicacion', 'departamento', 'usuario', 'usuarioRed', 'teleIp', 'nombreEquipo', 'placa', 'tipo', 'fabricante', 'modelo', 'serie', 'os', 'ip', 'ram', 'disco', 'estado'];
            const column = columns[columnIndex];
            
            filteredData.sort((a, b) => {
                let aVal = a[column] || '';
                let bVal = b[column] || '';
                
                if (sortDirection === 'asc') {
                    return aVal.localeCompare(bVal);
                } else {
                    return bVal.localeCompare(aVal);
                }
            });
            
            renderTable();
        }

        // ===== FUNCIONES DE MODAL =====
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Agregar Nuevo Equipo';
            document.getElementById('equipmentForm').reset();
            document.getElementById('ubicacion').value = 'CHIRIQUI';
            
            // Ocultar todos los campos custom
            document.querySelectorAll('.custom-input').forEach(input => {
                input.classList.remove('show');
                input.required = false;
                input.value = '';
            });
            
            // Poblar selects con datos existentes
            populateFormSelects();
            
            document.getElementById('equipmentModal').style.display = 'block';
        }

        function editItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            editingId = id;
            document.getElementById('modalTitle').textContent = 'Editar Equipo';
            
            // Poblar selects con datos existentes primero
            populateFormSelects();
            
            // Llenar campos b√°sicos
            document.getElementById('ubicacion').value = item.ubicacion || '';
            document.getElementById('usuario').value = item.usuario || '';
            document.getElementById('usuarioRed').value = item.usuarioRed || '';
            document.getElementById('teleIp').value = item.teleIp || '';
            document.getElementById('nombreEquipo').value = item.nombreEquipo || '';
            document.getElementById('placa').value = item.placa || '';
            document.getElementById('serie').value = item.serie || '';
            document.getElementById('ip').value = item.ip || '';
            
            // Llenar campos con opci√≥n "Otro"
            setFieldValue('departamento', item.departamento || '');
            setFieldValue('tipo', item.tipo || '');
            setFieldValue('fabricante', item.fabricante || '');
            setFieldValue('modelo', item.modelo || '');
            setFieldValue('os', item.os || '');
            setFieldValue('ram', item.ram || '');
            setFieldValue('disco', item.disco || '');
            
            document.getElementById('equipmentModal').style.display = 'block';
        }

        function deleteItem(id) {
            if (confirm('¬øEst√° seguro de que desea eliminar este equipo?')) {
                inventory = inventory.filter(item => item.id !== id);
                filteredData = filteredData.filter(item => item.id !== id);
                saveData();
                updateFilters();
                updateStats();
                renderTable();
                showSuccess('Equipo eliminado exitosamente');
            }
        }

        // FUNCI√ìN COPYITEM MANTENIDA INTACTA - NO MODIFICADA
        function copyItem(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            
            let copyText = '';
            const tipo = item.tipo ? item.tipo.toUpperCase() : '';
            
            // Formatear seg√∫n el tipo de equipo
            switch (tipo) {
                case 'COMPUTADORA DESKTOP':
                    copyText = `Nombre: ${item.usuario || ''}
C√≥digo de usuario de RED: ${item.usuarioRed || ''}
Direcci√≥n: ${item.departamento || ''}
Ubicaci√≥n: ${item.ubicacion || ''}
Tel√©fono/Extensi√≥n o IP: ${item.teleIp || ''}
Nombre del equipo en red: ${item.nombreEquipo || ''}
No. de Placa de Inventario: ${item.placa || ''}
Tipo: COMPUTADORA DESKTOP
Da√±o o Requerimiento: 
Atendido por: `;
                    break;
                    
                case 'LAPTOP':
                case 'COMPUTADORA LAPTOP':
                case 'COMPUTADORA PORTATIL':
                    copyText = `Nombre: ${item.usuario || ''}
C√≥digo de usuario de RED: ${item.usuarioRed || ''}
Direcci√≥n: ${item.departamento || ''}
Ubicaci√≥n: ${item.ubicacion || ''}
Tel√©fono/Extensi√≥n o IP: ${item.teleIp || ''}
Nombre del equipo en red: ${item.nombreEquipo || ''}
No. de Placa de Inventario: ${item.placa || ''}
Tipo: COMPUTADORA PORTATIL
Da√±o o Requerimiento: 
Atendido por: `;
                    break;
                    
                case 'MONITOR':
                    copyText = `Nombre: ${item.usuario || ''}
C√≥digo de usuario de RED: ${item.usuarioRed || ''}
Direcci√≥n: ${item.departamento || ''}
Ubicaci√≥n: ${item.ubicacion || ''}
Tel√©fono/Extensi√≥n o IP: ${item.teleIp || ''}
No. de Placa de Inventario: ${item.placa || ''}
Tipo: ${item.tipo || ''}
Fabricante: ${item.fabricante || ''}
Modelo: ${item.modelo || ''}
Serie: ${item.serie || ''}
Da√±o o Requerimiento: 
Atendido por: `;
                    break;
                    
                case 'TECLADO':
                    copyText = `Nombre: ${item.usuario || ''}
C√≥digo de usuario de RED: ${item.usuarioRed || ''}
Direcci√≥n: ${item.departamento || ''}
Ubicaci√≥n: ${item.ubicacion || ''}
Tel√©fono/Extensi√≥n o IP: ${item.teleIp || ''}
No. de Placa de Inventario: ${item.placa || ''}
Tipo: TECLADO
Fabricante: ${item.fabricante || 'H'}
Modelo: ${item.modelo || ''}
Serie: ${item.serie || ''}
Da√±o o Requerimiento: 
Atendido por: `;
                    break;
                    
                case 'IMPRESORA':
                    copyText = `Direcci√≥n: ${item.departamento || 'DINSIC'}
Ubicaci√≥n: ${item.ubicacion || 'CHIRIQUI'}
Tipo: IMPRESORA
Fabricante: ${item.fabricante || 'XEROX'}
Modelo: ${item.modelo || ''}
Serie: ${item.serie || ''}
IP: ${item.ip || ''}
Da√±o o Requerimiento: 
Atendido por: `;
                    break;
                    
                default:
                    // Formato gen√©rico para otros tipos de equipo
                    copyText = `Nombre: ${item.usuario || ''}
C√≥digo de usuario de RED: ${item.usuarioRed || ''}
Direcci√≥n: ${item.departamento || ''}
Ubicaci√≥n: ${item.ubicacion || 'CHIRIQUI'}
Tel√©fono/Extensi√≥n o IP: ${item.teleIp || ''}
No. de Placa de Inventario: ${item.placa || ''}
Tipo: ${tipo}
Fabricante: ${item.fabricante || ''}
Modelo: ${item.modelo || ''}
Serie: ${item.serie || ''}
Da√±o o Requerimiento: 
Atendido por: `;
                    break;
            }
            
            // Copiar al portapapeles
            navigator.clipboard.writeText(copyText).then(() => {
                showSuccess('Informaci√≥n copiada al portapapeles');
            }).catch(err => {
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = copyText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccess('Informaci√≥n copiada al portapapeles');
            });
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ===== FUNCIONES DE FORMULARIO =====
        document.getElementById('equipmentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                ubicacion: document.getElementById('ubicacion').value,
                departamento: getFieldValue('departamento'),
                usuario: document.getElementById('usuario').value,
                usuarioRed: document.getElementById('usuarioRed').value,
                teleIp: document.getElementById('teleIp').value,
                nombreEquipo: document.getElementById('nombreEquipo').value,
                placa: document.getElementById('placa').value,
                tipo: getFieldValue('tipo'),
                fabricante: getFieldValue('fabricante'),
                modelo: getFieldValue('modelo'),
                serie: document.getElementById('serie').value,
                os: getFieldValue('os'),
                ip: document.getElementById('ip').value,
                ram: getFieldValue('ram'),
                disco: getFieldValue('disco')
            };
            
            if (editingId) {
                // Editar equipo existente
                const index = inventory.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    inventory[index] = { ...inventory[index], ...formData };
                    showSuccess('Equipo actualizado exitosamente');
                }
            } else {
                // Agregar nuevo equipo
                const newItem = {
                    id: 'item_' + Date.now(),
                    ...formData,
                    estado: 'DISPONIBLE'
                };
                inventory.push(newItem);
                showSuccess('Equipo agregado exitosamente');
            }
            
            saveData();
            updateFilters();
            updateStats();
            
            // Aplicar filtros manteniendo el ordenamiento actual
            applyFiltersWithSort();
            
            closeModal('equipmentModal');
        });

        // ===== FUNCIONES DE PR√âSTAMOS =====
        function openLoansModal() {
            updateActiveLoans();
            updateLoanHistory();
            document.getElementById('loansModal').style.display = 'block';
        }

        function switchTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar pesta√±a seleccionada
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            // Actualizar contenido seg√∫n la pesta√±a
            if (tabName === 'activeLoan') {
                updateActiveLoans();
            } else if (tabName === 'loanHistory') {
                updateLoanHistory();
            }
        }

        function searchEquipmentForLoan() {
            const searchTerm = document.getElementById('searchEquipmentLoan').value.toLowerCase();
            const resultsContainer = document.getElementById('equipmentSearchResults');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            const availableEquipment = inventory.filter(item => 
                item.estado === 'DISPONIBLE' && 
                (item.placa?.toLowerCase().includes(searchTerm) ||
                 item.serie?.toLowerCase().includes(searchTerm) ||
                 item.nombreEquipo?.toLowerCase().includes(searchTerm) ||
                 item.tipo?.toLowerCase().includes(searchTerm))
            );
            
            resultsContainer.innerHTML = '';
            
            if (availableEquipment.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 10px; color: #666;">No se encontraron equipos disponibles</div>';
            } else {
                availableEquipment.forEach(item => {
                    const div = document.createElement('div');
                    div.style.cssText = 'padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; hover: background-color: #f5f5f5;';
                    div.innerHTML = `
                        <strong>${item.tipo} - ${item.fabricante} ${item.modelo}</strong><br>
                        <small>Placa: ${item.placa || 'N/A'} | Serie: ${item.serie || 'N/A'} | Usuario: ${item.usuario || 'N/A'}</small>
                    `;
                    div.onclick = () => selectEquipmentForLoan(item);
                    resultsContainer.appendChild(div);
                });
            }
            
            resultsContainer.style.display = 'block';
        }

        function selectEquipmentForLoan(equipment) {
            document.getElementById('selectedEquipmentId').value = equipment.id;
            document.getElementById('selectedEquipmentDisplay').value = `${equipment.tipo} - ${equipment.fabricante} ${equipment.modelo} (${equipment.placa || 'Sin placa'})`;
            document.getElementById('equipmentSearchResults').style.display = 'none';
            document.getElementById('searchEquipmentLoan').value = '';
        }

        function clearLoanForm() {
            document.getElementById('searchEquipmentLoan').value = '';
            document.getElementById('selectedEquipmentDisplay').value = '';
            document.getElementById('selectedEquipmentId').value = '';
            document.getElementById('loanBorrowerName').value = '';
            document.getElementById('loanStartDate').value = '';
            document.getElementById('loanExpectedReturn').value = '';
            document.getElementById('loanObservations').value = '';
            document.getElementById('equipmentSearchResults').style.display = 'none';
        }

        function createNewLoan() {
            const equipmentId = document.getElementById('selectedEquipmentId').value;
            const borrowerName = document.getElementById('loanBorrowerName').value;
            const startDate = document.getElementById('loanStartDate').value;
            const expectedReturn = document.getElementById('loanExpectedReturn').value;
            const observations = document.getElementById('loanObservations').value;
            
            if (!equipmentId || !borrowerName || !startDate || !expectedReturn) {
                showError('Por favor complete todos los campos obligatorios');
                return;
            }
            
            // Buscar el equipo
            const equipment = inventory.find(item => item.id === equipmentId);
            if (!equipment) {
                showError('Equipo no encontrado');
                return;
            }
            
            // Crear pr√©stamo
            const loan = {
                id: 'loan_' + Date.now(),
                equipmentId: equipmentId,
                equipmentInfo: `${equipment.tipo} - ${equipment.fabricante} ${equipment.modelo} (${equipment.placa || 'Sin placa'})`,
                borrowerName: borrowerName,
                startDate: startDate,
                expectedReturn: expectedReturn,
                observations: observations,
                status: 'ACTIVO',
                createdAt: new Date().toISOString()
            };
            
            loans.push(loan);
            
            // Actualizar estado del equipo
            equipment.estado = 'PRESTADO';
            
            saveData();
            updateStats();
            renderTable();
            clearLoanForm();
            updateActiveLoans();
            
            showSuccess('Pr√©stamo creado exitosamente');
        }

        function updateActiveLoans() {
            const activeLoans = loans.filter(loan => loan.status === 'ACTIVO');
            const container = document.getElementById('activeLoansContainer');
            
            if (activeLoans.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay pr√©stamos activos</p>';
                return;
            }
            
            container.innerHTML = '';
            
            activeLoans.forEach(loan => {
                const div = document.createElement('div');
                div.className = 'loan-item';
                div.innerHTML = `
                    <h4>${loan.equipmentInfo}</h4>
                    <div class="loan-details">
                        <div><strong>Prestatario:</strong> ${loan.borrowerName}</div>
                        <div><strong>Fecha pr√©stamo:</strong> ${loan.startDate}</div>
                        <div><strong>Fecha esperada:</strong> ${loan.expectedReturn}</div>
                        <div><strong>Estado:</strong> <span class="loan-status loan-active">${loan.status}</span></div>
                    </div>
                    ${loan.observations ? `<div style="margin-top: 10px;"><strong>Observaciones:</strong> ${loan.observations}</div>` : ''}
                    <div style="margin-top: 15px; text-align: right;">
                        <button class="btn btn-primary" onclick="returnEquipment('${loan.id}')">Devolver Equipo</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function returnEquipment(loanId) {
            if (!confirm('¬øConfirma la devoluci√≥n de este equipo?')) return;
            
            const loan = loans.find(l => l.id === loanId);
            if (!loan) return;
            
            // Actualizar pr√©stamo
            loan.status = 'DEVUELTO';
            loan.returnDate = new Date().toISOString().split('T')[0];
            
            // Actualizar estado del equipo
            const equipment = inventory.find(item => item.id === loan.equipmentId);
            if (equipment) {
                equipment.estado = 'DISPONIBLE';
            }
            
            saveData();
            updateStats();
            renderTable();
            updateActiveLoans();
            updateLoanHistory();
            
            showSuccess('Equipo devuelto exitosamente');
        }

        function updateLoanHistory() {
            const allLoans = [...loans].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            const container = document.getElementById('loanHistoryContainer');
            
            if (allLoans.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">No hay historial de pr√©stamos</p>';
                return;
            }
            
            container.innerHTML = '';
            
            allLoans.forEach(loan => {
                const div = document.createElement('div');
                div.className = 'loan-item';
                div.innerHTML = `
                    <h4>${loan.equipmentInfo}</h4>
                    <div class="loan-details">
                        <div><strong>Prestatario:</strong> ${loan.borrowerName}</div>
                        <div><strong>Fecha pr√©stamo:</strong> ${loan.startDate}</div>
                        <div><strong>Fecha esperada:</strong> ${loan.expectedReturn}</div>
                        <div><strong>Estado:</strong> <span class="loan-status ${loan.status === 'ACTIVO' ? 'loan-active' : 'loan-returned'}">${loan.status}</span></div>
                        ${loan.returnDate ? `<div><strong>Fecha devoluci√≥n:</strong> ${loan.returnDate}</div>` : ''}
                    </div>
                    ${loan.observations ? `<div style="margin-top: 10px;"><strong>Observaciones:</strong> ${loan.observations}</div>` : ''}
                `;
                container.appendChild(div);
            });
        }

        function updateLoanEquipmentSelect() {
            // Esta funci√≥n se mantiene para compatibilidad pero ya no se usa
        }

        // ===== FUNCIONES DE REPORTES =====
        function openReportModal() {
            populateReportFilters();
            document.getElementById('reportModal').style.display = 'block';
        }

        function populateReportFilters() {
            const departments = [...new Set(inventory.map(item => item.departamento))].sort();
            const types = [...new Set(inventory.map(item => item.tipo))].sort();
            const users = [...new Set(inventory.map(item => item.usuario))].sort();

            populateSelect('reportDepartamento', departments);
            populateSelect('reportTipo', types);
            populateSelect('reportUsuario', users);
        }

        function updateUsuarioSelect() {
            const departamento = document.getElementById('reportDepartamento').value;
            const users = [...new Set(inventory
                .filter(item => !departamento || item.departamento === departamento)
                .map(item => item.usuario)
            )].sort();
            
            populateSelect('reportUsuario', users);
        }

        function showReportPreview() {
            const data = getFilteredReportData();
            const html = generateReportHTML(data, true);
            
            document.getElementById('previewContainer').innerHTML = html;
            document.getElementById('previewModal').style.display = 'block';
        }

        function generatePrintableReport() {
            const data = getFilteredReportData();
            const html = generateReportHTML(data, false);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Reporte de Inventario</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2a5298; padding-bottom: 20px; }
                        .print-title { font-size: 1.5rem; font-weight: bold; color: #2a5298; margin-bottom: 10px; }
                        .print-subtitle { font-size: 1rem; color: #6c757d; margin-bottom: 5px; }
                        .print-date { font-size: 0.9rem; color: #6c757d; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.8rem; }
                        th { background-color: #2a5298; color: white; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .estado-badge { padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: bold; }
                        .estado-disponible { background-color: #d4edda; color: #155724; }
                        .estado-prestado { background-color: #fff3cd; color: #856404; }
                    </style>
                </head>
                <body>
                    ${html}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            closeModal('reportModal');
            showSuccess('Reporte enviado a impresi√≥n');
        }

        function getFilteredReportData() {
            const departamento = document.getElementById('reportDepartamento').value;
            const tipo = document.getElementById('reportTipo').value;
            const usuario = document.getElementById('reportUsuario').value;
            
            return inventory.filter(item => {
                return (!departamento || item.departamento === departamento) &&
                       (!tipo || item.tipo === tipo) &&
                       (!usuario || item.usuario === usuario);
            });
        }

        function generateReportHTML(data, isPreview) {
            const departamento = document.getElementById('reportDepartamento').value;
            const tipo = document.getElementById('reportTipo').value;
            const usuario = document.getElementById('reportUsuario').value;
            
            let filters = [];
            if (departamento) filters.push(`Departamento: ${departamento}`);
            if (tipo) filters.push(`Tipo: ${tipo}`);
            if (usuario) filters.push(`Usuario: ${usuario}`);
            
            const filterText = filters.length > 0 ? ` (${filters.join(', ')})` : '';
            const currentDate = new Date().toLocaleDateString('es-ES');
            
            let html = `
                <div class="print-header">
                    <div class="print-title">REPORTE DE INVENTARIO TECNOL√ìGICO</div>
                    <div class="print-subtitle">Direcci√≥n de Tecnolog√≠a Provincial de Veraguas</div>
                    <div class="print-subtitle">Total de registros: ${data.length}${filterText}</div>
                    <div class="print-date">Fecha de generaci√≥n: ${currentDate}</div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>UBICACI√ìN</th>
                            <th>DEPARTAMENTO</th>
                            <th>USUARIO</th>
                            <th>USUARIO RED</th>
                            <th>TELE-IP</th>
                            <th>NOMBRE EQUIPO</th>
                            <th>PLACA</th>
                            <th>TIPO</th>
                            <th>FABRICANTE</th>
                            <th>MODELO</th>
                            <th>SERIE</th>
                            <th>OS</th>
                            <th>IP</th>
                            <th>RAM</th>
                            <th>DISCO</th>
                            <th>ESTADO</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(item => {
                html += `
                    <tr>
                        <td>${item.ubicacion || 'N/A'}</td>
                        <td>${item.departamento || 'N/A'}</td>
                        <td>${item.usuario || 'N/A'}</td>
                        <td>${item.usuarioRed || 'N/A'}</td>
                        <td>${item.teleIp || 'N/A'}</td>
                        <td>${item.nombreEquipo || 'N/A'}</td>
                        <td>${item.placa || 'N/A'}</td>
                        <td>${item.tipo || 'N/A'}</td>
                        <td>${item.fabricante || 'N/A'}</td>
                        <td>${item.modelo || 'N/A'}</td>
                        <td>${item.serie || 'N/A'}</td>
                        <td>${item.os || 'N/A'}</td>
                        <td>${item.ip || 'N/A'}</td>
                        <td>${item.ram || 'N/A'}</td>
                        <td>${item.disco || 'N/A'}</td>
                        <td><span class="estado-badge estado-${item.estado.toLowerCase()}">${item.estado}</span></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            return html;
        }

        function printFromPreview() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Reporte de Inventario</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .print-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2a5298; padding-bottom: 20px; }
                        .print-title { font-size: 1.5rem; font-weight: bold; color: #2a5298; margin-bottom: 10px; }
                        .print-subtitle { font-size: 1rem; color: #6c757d; margin-bottom: 5px; }
                        .print-date { font-size: 0.9rem; color: #6c757d; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; font-size: 0.8rem; }
                        th { background-color: #2a5298; color: white; }
                        tr:nth-child(even) { background-color: #f2f2f2; }
                        .estado-badge { padding: 2px 6px; border-radius: 8px; font-size: 0.7rem; font-weight: bold; }
                        .estado-disponible { background-color: #d4edda; color: #155724; }
                        .estado-prestado { background-color: #fff3cd; color: #856404; }
                    </style>
                </head>
                <body>
                    ${document.getElementById('previewContainer').innerHTML}
                </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
            
            closeModal('previewModal');
        }

        // ===== FUNCIONES DE EXPORTACI√ìN E IMPORTACI√ìN =====
        // FUNCI√ìN CORREGIDA: Orden correcto de columnas en exportaci√≥n CSV
        function exportToCSV() {
            const headers = ['UBICACI√ìN', 'DEPARTAMENTO', 'USUARIO', 'USUARIO_RED', 'TELE-IP', 'NOMBRE_EQUIPO', 'PLACA', 'TIPO', 'FABRICANTE', 'MODELO', 'SERIE', 'OS', 'IP', 'RAM', 'DISCO'];
            let csvContent = '"' + headers.join('";"') + '"\n';
            
            inventory.forEach(item => {
                const row = [
                    item.ubicacion || '',
                    item.departamento || '',
                    item.usuario || '',
                    item.usuarioRed || '',
                    item.teleIp || '',
                    item.nombreEquipo || '',
                    item.placa || '',
                    item.tipo || '',
                    item.fabricante || '',
                    item.modelo || '',
                    item.serie || '',
                    item.os || '',
                    item.ip || '',
                    item.ram || '',
                    item.disco || ''
                ];
                csvContent += '"' + row.join('";"') + '"\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `inventario_tecnologico_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Archivo CSV exportado exitosamente');
        }

        function importFromCSV() {
            document.getElementById('csvFileInput').click();
        }

        // FUNCI√ìN REPARADA: Mantiene iconos correctos despu√©s de importar CSV
        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n');
                    const headers = lines[0].split(';').map(h => h.replace(/"/g, '').trim());
                    
                    // Limpiar inventario existente antes de importar
                    inventory = [];
                    
                    const newItems = [];
                    for (let i = 1; i < lines.length; i++) {
                        if (lines[i].trim() === '') continue;
                        
                        const values = lines[i].split(';').map(v => v.replace(/"/g, '').trim());
                        const item = {
                            id: 'item_' + Date.now() + '_' + i,
                            ubicacion: values[0] || 'CHIRIQUI',
                            departamento: values[1] || '',
                            usuario: values[2] || '',
                            usuarioRed: values[3] || '',
                            teleIp: values[4] || '',
                            nombreEquipo: values[5] || '',
                            placa: values[6] || '',
                            tipo: values[7] || 'OTRO',
                            fabricante: values[8] || '',
                            modelo: values[9] || '',
                            serie: values[10] || '',
                            os: values[11] || '',
                            ip: values[12] || '',
                            ram: values[13] || '',
                            disco: values[14] || '',
                            estado: 'DISPONIBLE'
                        };
                        newItems.push(item);
                    }
                    
                    inventory = newItems;
                    filteredData = [...inventory];
                    saveData();
                    updateFilters();
                    updateStats(); // Esto llamar√° a updateEquipmentTypes() con el mapeo correcto
                    
                    // Aplicar filtros actuales para mantener la b√∫squeda si existe
                    applyFilters();
                    
                    updateLastUpdated();
                    showSuccess(`${newItems.length} equipos importados exitosamente`);
                } catch (error) {
                    console.error('Error al importar CSV:', error);
                    showError('Error al importar el archivo CSV. Verifique el formato del archivo.');
                }
            };
            reader.readAsText(file);
        }

        function backupData() {
            const backupData = {
                inventory: inventory,
                loans: loans,
                timestamp: new Date().toISOString(),
                version: '1.0'
            };

            const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `respaldo_inventario_${new Date().toISOString().split('T')[0]}.json`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess('Respaldo creado exitosamente');
        }

        // NUEVA FUNCI√ìN: Restaurar datos desde archivo JSON
        function restoreData() {
            document.getElementById('jsonFileInput').click();
        }

        function handleJSONRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    if (!backupData.inventory || !Array.isArray(backupData.inventory)) {
                        showError('Archivo de respaldo inv√°lido');
                        return;
                    }
                    
                    if (confirm('¬øEst√° seguro de que desea restaurar los datos? Esto reemplazar√° todos los datos actuales.')) {
                        inventory = backupData.inventory;
                        loans = backupData.loans || [];
                        filteredData = [...inventory];
                        
                        saveData();
                        updateFilters();
                        updateStats();
                        renderTable();
                        updateLastUpdated();
                        
                        showSuccess(`Datos restaurados exitosamente. ${inventory.length} equipos y ${loans.length} pr√©stamos cargados.`);
                    }
                } catch (error) {
                    showError('Error al leer el archivo de respaldo');
                }
            };
            reader.readAsText(file);
        }

        function clearAllData() {
            if (confirm('¬øEst√° seguro de que desea eliminar TODOS los datos? Esta acci√≥n no se puede deshacer.')) {
                if (confirm('CONFIRMACI√ìN FINAL: Se eliminar√°n todos los equipos y pr√©stamos. ¬øContinuar?')) {
                    inventory = [];
                    loans = [];
                    filteredData = [];
                    localStorage.removeItem('inventory');
                    localStorage.removeItem('loans');
                    
                    updateFilters();
                    updateStats();
                    renderTable();
                    updateLastUpdated();
                    
                    showSuccess('Todos los datos han sido eliminados');
                }
            }
        }

        // ===== FUNCIONES DE GU√çA TELEF√ìNICA =====
        function openPhoneGuideModal() {
            populatePhoneGuideDepartments();
            applyPhoneGuideFilters();
            document.getElementById('phoneGuideModal').style.display = 'block';
        }

        function populatePhoneGuideDepartments() {
            const departments = [...new Set(inventory.map(item => item.departamento).filter(dept => dept && dept.trim() !== ''))].sort();
            const select = document.getElementById('phoneGuideDepartmentFilter');
            
            // Limpiar opciones existentes excepto la primera
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // Agregar departamentos
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                select.appendChild(option);
            });
        }

        function applyPhoneGuideFilters() {
            const departmentFilter = document.getElementById('phoneGuideDepartmentFilter').value;
            const searchTerm = document.getElementById('phoneGuideSearchInput').value.toLowerCase();
            
            // Filtrar contactos √∫nicos por usuario
            const uniqueContacts = [];
            const seenUsers = new Set();
            
            inventory.forEach(item => {
                const userKey = `${item.usuario}_${item.departamento}`;
                if (!seenUsers.has(userKey) && item.usuario && item.usuario.trim() !== '') {
                    seenUsers.add(userKey);
                    uniqueContacts.push({
                        departamento: item.departamento || 'N/A',
                        usuario: item.usuario || 'N/A',
                        teleIp: item.teleIp || 'N/A',
                        usuarioRed: item.usuarioRed || 'N/A',
                        ubicacion: item.ubicacion || 'N/A'
                    });
                }
            });
            
            // Aplicar filtros
            let filteredContacts = uniqueContacts.filter(contact => {
                const matchesDepartment = !departmentFilter || contact.departamento === departmentFilter;
                const matchesSearch = !searchTerm || 
                    contact.usuario.toLowerCase().includes(searchTerm) ||
                    contact.teleIp.toLowerCase().includes(searchTerm) ||
                    contact.usuarioRed.toLowerCase().includes(searchTerm) ||
                    contact.departamento.toLowerCase().includes(searchTerm);
                
                return matchesDepartment && matchesSearch;
            });
            
            // Ordenar por departamento y luego por usuario
            filteredContacts.sort((a, b) => {
                if (a.departamento !== b.departamento) {
                    return a.departamento.localeCompare(b.departamento);
                }
                return a.usuario.localeCompare(b.usuario);
            });
            
            renderPhoneGuideTable(filteredContacts);
            updatePhoneGuideStats(filteredContacts.length);
        }

        function renderPhoneGuideTable(contacts) {
            const tbody = document.getElementById('phoneGuideTableBody');
            tbody.innerHTML = '';
            
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #ddd';
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd;">${contact.departamento}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">${contact.usuario}</td>
                    <td style="padding: 8px; border: 1px solid #ddd; color: #2a5298; font-weight: 600;">${contact.teleIp}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${contact.usuarioRed}</td>
                    <td style="padding: 8px; border: 1px solid #ddd;">${contact.ubicacion}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function updatePhoneGuideStats(count) {
            const statsElement = document.getElementById('phoneGuideStats');
            statsElement.textContent = `Mostrando ${count} contacto${count !== 1 ? 's' : ''}`;
        }

        function clearPhoneGuideFilters() {
            document.getElementById('phoneGuideDepartmentFilter').value = '';
            document.getElementById('phoneGuideSearchInput').value = '';
            applyPhoneGuideFilters();
        }

        function exportPhoneGuide() {
            const departmentFilter = document.getElementById('phoneGuideDepartmentFilter').value;
            const searchTerm = document.getElementById('phoneGuideSearchInput').value.toLowerCase();
            
            // Obtener contactos filtrados
            const uniqueContacts = [];
            const seenUsers = new Set();
            
            inventory.forEach(item => {
                const userKey = `${item.usuario}_${item.departamento}`;
                if (!seenUsers.has(userKey) && item.usuario && item.usuario.trim() !== '') {
                    seenUsers.add(userKey);
                    uniqueContacts.push({
                        departamento: item.departamento || 'N/A',
                        usuario: item.usuario || 'N/A',
                        teleIp: item.teleIp || 'N/A',
                        usuarioRed: item.usuarioRed || 'N/A',
                        ubicacion: item.ubicacion || 'N/A'
                    });
                }
            });
            
            let filteredContacts = uniqueContacts.filter(contact => {
                const matchesDepartment = !departmentFilter || contact.departamento === departmentFilter;
                const matchesSearch = !searchTerm || 
                    contact.usuario.toLowerCase().includes(searchTerm) ||
                    contact.teleIp.toLowerCase().includes(searchTerm) ||
                    contact.usuarioRed.toLowerCase().includes(searchTerm) ||
                    contact.departamento.toLowerCase().includes(searchTerm);
                
                return matchesDepartment && matchesSearch;
            });
            
            // Ordenar contactos
            filteredContacts.sort((a, b) => {
                if (a.departamento !== b.departamento) {
                    return a.departamento.localeCompare(b.departamento);
                }
                return a.usuario.localeCompare(b.usuario);
            });
            
            // Crear CSV
            const headers = ['DEPARTAMENTO', 'USUARIO', 'TELEFONO_IP', 'USUARIO_RED', 'UBICACION'];
            const csvContent = [
                headers.join(';'),
                ...filteredContacts.map(contact => [
                    `"${contact.departamento}"`,
                    `"${contact.usuario}"`,
                    `"${contact.teleIp}"`,
                    `"${contact.usuarioRed}"`,
                    `"${contact.ubicacion}"`
                ].join(';'))
            ].join('\n');
            
            // Descargar archivo
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `guia_telefonica_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccess(`Gu√≠a telef√≥nica exportada: ${filteredContacts.length} contactos`);
        }

        // ===== FUNCIONES DE UTILIDAD =====
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success-message';
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }

        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error-message';
            div.textContent = message;
            document.body.appendChild(div);
            
            setTimeout(() => {
                document.body.removeChild(div);
            }, 3000);
        }
    </script>
</body>
</html>

